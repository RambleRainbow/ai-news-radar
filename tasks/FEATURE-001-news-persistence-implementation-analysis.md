# FEATURE-001: 新闻持久化 - 实现分析

## 分析总结

### 当前架构

```
┌─────────────────────────────────────────────┐
│  Presentation Layer (CLI)                          │
│  • skill/scripts/main.py (CLI interface)            │
└─────────────────────────────────────────────┘
│ Business Logic Layer                                │
│  • skill/core/news_radar.py (NewsRadar class)       │
│  • save_to_json(), save_to_csv() methods            │
└─────────────────────────────────────────────┘
│ Storage Abstraction Layer                          │
│  • skill/storage/json_storage.py (JSONStorage)      │
└─────────────────────────────────────────────┘
│  Data Storage Layer                                 │
│  • skill/assets/data/ 目录中的 JSON 文件           │
└─────────────────────────────────────────────┘
```

## 现有实现

| 组件 | 位置 | 功能 | 状态 |
|------|------|------|------|
| **CLI 接口** | skill/scripts/main.py | Click 命令解析 | ✅ |
| **NewsRadar 类** | skill/core/news_radar.py | 聚合、过滤、存储 | ✅ |
| **JSON 存储** | skill/storage/json_storage.py | save(), load() 方法 | ✅ |

## 发现的问题

1. **数据丢失风险**
   - 每次保存会覆盖之前的所有数据
   - 没有历史记录功能
   - 无法查询特定时间点的数据

2. **架构耦合**
   - NewsRadar 类直接依赖 JSONStorage
   - 难以切换存储后端

3. **缺少查询功能**
   - 无法按条件查询新闻
   - 无法分页加载
   - 无法查询特定源的数据

4. **内存占用**
   - 所有数据加载到内存
   - 大数据集会占用大量内存

## 推荐方案

### 方案 A：增量 JSON 文件（推荐）

```yaml
# 保持最近 24 小时的数据在 latest-24h.json
# 历史数据
# 每次保存时，将旧数据移动到 history/ 目录
```

**实现步骤：**
1. 修改 `save()` 方法，支持增量保存
2. 添加历史记录功能（保留最近 N 小时的数据）
3. 实现查询接口（按时间、源、关键词）

**优点：**
- ✅ 简单实现
- ✅ 无外部依赖
- ✅ 符合现有架构

**缺点：**
- ❌ 内存占用较高
- ❌ 需要重构查询逻辑

### 方案 B：分文件存储（备选）

```yaml
# 每天一个 JSON 文件
# 文件格式: news-2024-03-01.json
# 查询时按日期范围加载
```

**实现步骤：**
1. 创建分文件存储管理器
2. 按日期保存到独立文件
3. 查询时合并多个文件

**优点：**
- ✅ 查询性能好（只加载需要的数据）
- ✅ 内存占用低
- ✅ 支持任意时间范围查询

**缺点：**
- ❌ 文件管理复杂
- ❌ 需要重构查询接口

### 方案 C：SQLite 数据库（生产环境）

```python
# 使用 SQLAlchemy 或 sqlite3
# 数据库表设计
# 支持完整 CRUD 和查询
```

## 关键决策点

| 决策因素 | 方案 A | 方案 B | 方案 C |
|--------|------|------|------|
| **实现复杂度** | 简单 | 中 | 高 |
| **内存占用** | 高 | 低 | 低 |
| **查询性能** | 低 | 中 | 高 |
| **历史记录** | 需重构 | 支持 | 支持 |
| **开发时间** | 1-2 天 | 3-5 天 | 1-2 周 |

## 建议

基于当前项目情况和需求，**推荐方案 A（增量 JSON 文件）**：

1. 先实现基本的增量保存功能
2. 后续可优化为分文件存储或数据库
3. 保持 NewsRadar 类的简单接口，只替换存储后端

## 验收标准

- [x] 可以独立保存新闻数据（latest-24h.json）
- [x] 可以加载历史数据（通过查询接口）
- [x] 数据格式兼容现有 NewsRadar.save_to_json()
